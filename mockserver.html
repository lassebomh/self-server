<!DOCTYPE html>
<html>
    <body>
        
        <script type="module">
            import mime from 'https://esm.sh/mime@4.0.1/lite';

            let files;

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/serviceworker.js').then(() => {
                    console.log('Service Worker registered');
                    
                    window.addEventListener('message', (e) => {
                        if (window.parent !== e.source) return
                    
                        if (e.data.type == 'init') {
                            files = e.data.value;

                            let script = document.createElement('script')
                            script.type = 'module'
                            script.innerHTML = files['/server.js']
                            document.body.appendChild(script)
                        }

                        navigator.serviceWorker.onmessage = async (event) => {

                            let response;

                            if (event.data.self) {
                                let url = new URL(event.data.request.url)

                                let fileContents = files[url.pathname]

                                if (fileContents !== undefined) {
                                    response = new Response(fileContents, {
                                        status: 200,
                                        headers: {
                                            'Content-Type': mime.getType(url.pathname),
                                        }
                                    })
                                } else {
                                    response = new Response(null, {status: 404});
                                }

                            } else {
                                response = await window.requestHandler(event.data.request);
                            }

                            const clonedResponse = response.clone();
                            const body = await clonedResponse.blob();
                            const headers = Object.fromEntries(response.headers.entries());

                            const serializedResponse = {
                                body: body,
                                status: response.status,
                                statusText: response.statusText,
                                headers: headers
                            };

                            event.ports[0].postMessage({ id: event.data.id, response: serializedResponse });
                        };

                    })

                    window.parent.postMessage({type: "init", ok: true}, '*')

                }).catch(error => {
                    console.error('Service Worker registration failed:', error);
                    window.parent.postMessage({type: "init", ok: false}, '*')
                });
            }

            window.beforeunload = async () => {
                if ('serviceWorker' in navigator) {
                    let registrations = await navigator.serviceWorker.getRegistrations();
                    
                    for (let registration of registrations) {
                        console.log("Unregistered", registration);
                        registration.unregister();
                    }
                }
            };
        </script>
    </body>
</html>